<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CASA DOMOTICA</title>
  <style>
    :root{
      --bg:#0f1724; --panel:#0b1220; --accent:#6ee7b7; --danger:#ff6b6b; --warm:#ffb86b; --glass: rgba(255,255,255,0.03);
      --card-radius:16px; --soft: 12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #081427 100%);color:#dde6f0}
    .app{max-width:1200px;margin:20px auto;padding:20px;display:grid;grid-template-columns:1fr 380px;gap:18px}
    header{grid-column:1/-1;display:flex;align-items:center;gap:16px}
    h1{font-size:18px;margin:0}
    .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
    .card{background:var(--panel);border-radius:var(--card-radius);padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}

    /* Dials area */
    .dials{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .dial{display:flex;flex-direction:column;align-items:center;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px}
    .dial h3{margin:6px 0 0;font-weight:600;font-size:14px}
    .gauge{width:160px;height:120px;display:block}
    .big{font-size:28px;font-weight:700}

    /* Right column */
    .right{display:flex;flex-direction:column;gap:14px}

    /* Buttons */
    .btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06);padding:10px 16px;border-radius:12px;color:inherit;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#0ea5a5,#06b6d4);color:#021018}
    .switch{display:inline-flex;align-items:center;gap:8px}

    /* Fan / Heater controls */
    .actuators{display:flex;gap:10px}
    .actuators .btn{flex:1}

    /* Graphs */
    .graph{height:160px;border-radius:12px;padding:8px;background:var(--glass);overflow:hidden}

    /* Alerts border */
    .alert-border{box-shadow:0 0 0 4px transparent inset;transition:box-shadow .4s ease}
    .alert-cold{box-shadow:0 0 0 6px rgba(59,130,246,0.25) inset}
    .alert-hot{box-shadow:0 0 0 6px rgba(234,88,12,0.22) inset}

    /* Bluetooth status */
    .status{font-size:13px;opacity:.9}

    /* small helpers */
    .row{display:flex;gap:12px;align-items:center}
    .muted{opacity:.7;font-size:13px}
    footer{grid-column:1/-1;text-align:center;opacity:.6;margin-top:8px;font-size:13px}

    /* Transitions for smooth gauge needle */
    .needle{transition:transform 700ms cubic-bezier(.22,.9,.3,1)}

    @media(max-width:900px){.app{grid-template-columns:1fr;}
      .gauge{width:120px;height:90px}
    }
  </style>
</head>
<body>
  <div class="app card alert-border" id="root">
    <header>
      <h1>CASA DOMOTICA — 4 sensores Dallas (DS18B20)</h1>
      <div class="controls">
        <div class="status" id="btStatus">Bluetooth: desconectado</div>
        <button class="btn" id="btnConnect">Conectar ESP32 (BLE)</button>
        <label class="switch muted">Modo: <select id="modeSelect" class="btn" style="padding:6px 8px;border-radius:10px;min-width:120px"> <option value="auto">Automático</option><option value="manual">Manual</option></select></label>
      </div>
    </header>

    <section style="display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;gap:12px">
        <div style="flex:1" class="card">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="flex:1">
              <div class="dials" id="dialsContainer">
                <!-- dials inserted by JS -->
              </div>

              <!-- Panel visual llamativo para temperaturas individuales -->
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px" id="tempCards">
                <div class="card" style="text-align:center;padding:14px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.05);border-radius:14px">
                  <div class="muted">Sensor 1</div>
                  <div style="font-size:26px;font-weight:700;color:#6ee7b7" id="card-t1">-- °C</div>
                </div>
                <div class="card" style="text-align:center;padding:14px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.05);border-radius:14px">
                  <div class="muted">Sensor 2</div>
                  <div style="font-size:26px;font-weight:700;color:#38bdf8" id="card-t2">-- °C</div>
                </div>
                <div class="card" style="text-align:center;padding:14px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.05);border-radius:14px">
                  <div class="muted">Sensor 3</div>
                  <div style="font-size:26px;font-weight:700;color:#facc15" id="card-t3">-- °C</div>
                </div>
                <div class="card" style="text-align:center;padding:14px 8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.05);border-radius:14px">
                  <div class="muted">Sensor 4</div>
                  <div style="font-size:26px;font-weight:700;color:#fb7185" id="card-t4">-- °C</div>
                </div>
              </div>
            </div>
            <div style="width:220px" class="card" id="avgCard">
              <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
                <div class="muted">Temperatura promedio</div>
                <div class="big" id="avgTemp">-- °C</div>
                <div class="muted">Últimas 20 muestras</div>
                <canvas id="avgGraph" class="graph" width="200" height="120"></canvas>
                <div class="row" style="width:100%;justify-content:space-between">
                  <div class="muted">Ventilador: <strong id="fanState">OFF</strong></div>
                  <div class="muted">Calefactor: <strong id="heaterState">OFF</strong></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <aside class="right">
          <div class="card">
            <div style="display:flex;flex-direction:column;gap:10px">
              <div class="muted">Actuadores</div>
              <div class="actuators">
                <button class="btn" id="fanOn">Encender Ventilador</button>
                <button class="btn" id="fanOff">Apagar Ventilador</button>
              </div>
              <div class="actuators">
                <button class="btn" id="heaterOn">Encender Calefactor</button>
                <button class="btn" id="heaterOff">Apagar Calefactor</button>
              </div>
              <div class="muted">Modo actual: <strong id="currentMode">Automático</strong></div>
              <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
                <button class="btn primary" id="btnReqSample">Pedir muestra (manual)</button>
                <div class="muted">Última lectura: <span id="lastTime">--</span></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="muted">Gráficas individuales (últimas 20 muestras)</div>
            <canvas id="g1" class="graph" width="320" height="120" style="margin-top:8px"></canvas>
            <canvas id="g2" class="graph" width="320" height="120" style="margin-top:8px"></canvas>
          </div>
        </aside>
      </div>

      <div class="card" style="grid-column:1/-1">
        <div class="muted">Notas de funcionamiento</div>
        <ul>
          <li>Modo <strong>automático</strong>: Ventilador ON si promedio &gt; 25 °C; Calefactor ON si promedio &lt; 20 °C. Entre 20–25 °C ambos OFF.</li>
          <li>En modo <strong>manual</strong> puedes controlar actuadores con los botones. Los comandos se envían al ESP32 vía BLE (si está conectado).</li>
          <li>La comunicación BLE requiere que el ESP32 exponga un servicio y característica escritos (por ejemplo Nordic UART / NUS) que envíen JSON con la forma: <code>{"t1":23.4,"t2":22.9,"t3":23.1,"t4":22.8}</code></li>
        </ul>
      </div>
    </section>

    <footer>Dashboard creado para ESP32 + 4x DS18B20 — muestra y controla por Bluetooth</footer>
  </div>

  <script>
    /* -------------------- Simple Gauge rendering -------------------- */
    function makeDial(id,title){
      const div = document.createElement('div');div.className='dial card';div.innerHTML=\`
        <div style=\"display:flex;flex-direction:column;align-items:center;gap:6px\">
          <svg class=\"gauge\" viewBox=\"0 0 160 120\" id=\"gauge-${id}\">
            <defs>
              <linearGradient id=\"ggrad-${id}\" x1=\"0\" x2=\"1\"> <stop offset=\"0%\" stop-color=\"#6ee7b7\"/> <stop offset=\"100%\" stop-color=\"#38bdf8\"/> </linearGradient>
            </defs>
            <path d=\"M20 100 A60 60 0 0 1 140 100\" stroke=\"#173443\" stroke-width=18 fill=\"none\" stroke-linecap=\"round\"></path>
            <path d=\"M20 100 A60 60 0 0 1 140 100\" stroke=\"url(#ggrad-${id})\" stroke-width=12 fill=\"none\" stroke-linecap=\"round\" stroke-dasharray=\"0 999\" id=\"arc-${id}\"></path>
            <g transform=\"translate(80,100)\">
              <line x1=\"0\" y1=\"0\" x2=\"0\" y2=\"-60\" stroke=\"#fff\" stroke-width=2 class=\"needle\" id=\"needle-${id}\" style=\"transform-origin:0px 0px\"></line>
              <circle cx=\"0\" cy=\"0\" r=\"4\" fill=\"#fff\"></circle>
            </g>
            <text x=\"80\" y=\"72\" text-anchor=\"middle\" font-size=\"15\" fill=\"#cfeff0\" id=\"val-${id}\">-- °C</text>
          </svg>
          <h3>${title}</h3>
          <div class=\"muted\" id=\"num-$1\">-- °C</div>
        </div>
      \`;
      return div;
    }

    const dialsContainer = document.getElementById('dialsContainer');
    const names=['Garaje','Patio','Sala','Comedor']; for(let i=1;i<=4;i++){ dialsContainer.appendChild(makeDial(i, names[i-1])); }

    const state = {
      t:[null,null,null,null],
      history: [[],[],[],[]],
      avgHistory: [],
      fan:false, heater:false,
      mode:'auto',
      connected:false
    };

    // helper to map temperature to needle angle (-90..90)
    function tempToAngle(t){ const min= -40, max=60; const clamped = Math.max(min,Math.min(max,t)); return ( (clamped - min) / (max - min) ) * 180 - 90; }

    function updateDial(i,val){
      const arc = document.getElementById('arc-'+(i+''));
      const needle = document.getElementById('needle-'+(i+''));
      const txt = document.getElementById('val-'+(i+''));
      if(!arc||!needle||!txt) return;
      const pct = Math.max(0,Math.min(1,(val+40)/100));
      const full = 380; // approximate arc length
      arc.setAttribute('stroke-dasharray', (pct*full).toFixed(1) + ' 999');
      const a = tempToAngle(val);
      needle.style.transform = `rotate(${a}deg)`;
      txt.textContent = val.toFixed(1) + ' °C';
    }

    function updateAvgUI(){
      const avg = computeAvg();
      document.getElementById('avgTemp').textContent = isNaN(avg)?'-- °C':avg.toFixed(2)+' °C';
      document.getElementById('lastTime').textContent = new Date().toLocaleTimeString();
      document.getElementById('fanState').textContent = state.fan? 'ON':'OFF';
      document.getElementById('heaterState').textContent = state.heater? 'ON':'OFF';
      updateGraphs();

      // Alerts border
      const root = document.getElementById('root');
      root.classList.remove('alert-cold','alert-hot');
      if(!isNaN(avg)){
        if(avg > 25){ root.classList.add('alert-hot'); }
        else if(avg < 20){ root.classList.add('alert-cold'); }
      }
    }

    function computeAvg(){
      const vals = state.t.filter(v=>typeof v==='number');
      if(vals.length===0) return NaN; return vals.reduce((a,b)=>a+b,0)/vals.length;
    }

    // Simple canvas line charts (last 20)
    function updateGraphs(){
      // individual small graphs g1,g2 -> use pairs
      const cnv1 = document.getElementById('g1'); const ctx1 = cnv1.getContext('2d');
      const cnv2 = document.getElementById('g2'); const ctx2 = cnv2.getContext('2d');
      const cnvAvg = document.getElementById('avgGraph'); const cavg = cnvAvg.getContext('2d');

      function draw(ctx, arrays, labels){
        const W = ctx.canvas.width; const H = ctx.canvas.height; ctx.clearRect(0,0,W,H);
        ctx.lineWidth=2; ctx.beginPath();
        const maxSamples = 20;
        // find min max
        let all = arrays.flat().filter(x=>typeof x==='number');
        let min = Math.min( (all.length?Math.min(...all):0), 0 );
        let max = Math.max( (all.length?Math.max(...all):30), 50 );
        if(min===max){ max = min + 10; }
        arrays.forEach((arr,idx)=>{
          const display = arr.slice(-maxSamples);
          ctx.beginPath();
          for(let i=0;i<maxSamples;i++){
            const x = (i/(maxSamples-1))*W;
            const v = display[i]!==undefined?display[i]:NaN;
            const y = isNaN(v)?H: H - ( (v - min) / (max-min) ) * H;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          ctx.stroke();
        });
      }

      draw(ctx1, [state.history[0], state.history[1]] );
      draw(ctx2, [state.history[2], state.history[3]] );
      draw(cavg, [state.avgHistory]);
    }

    // Keep histories bounded
    function pushSample(tarr){
      for(let i=0;i<4;i++){
        if(typeof tarr[i]==='number'){
          state.t[i]=tarr[i];
          state.history[i].push(tarr[i]); if(state.history[i].length>60) state.history[i].shift();
          updateDial(i+1,tarr[i]);
        }
      }
      const avg = computeAvg(); if(!isNaN(avg)) { state.avgHistory.push(avg); if(state.avgHistory.length>60) state.avgHistory.shift(); }
      updateAvgUI();
      applyAutoRules();
    }

    /* -------------------- Actuadores: envío de comandos -------------------- */
    function sendCommand(cmd){
      // cmd is plain text string. If connected via BLE we send through writeCharacteristic
      if(window.bleWriter && window.bleWriter.writeValue){
        const enc = new TextEncoder(); window.bleWriter.writeValue(enc.encode(cmd+"\n")).catch(console.error);
      } else {
        console.log('No BLE writer — comando local',cmd);
      }
    }

    document.getElementById('fanOn').onclick = ()=>{ state.fan=true; document.getElementById('fanState').textContent='ON'; sendCommand('FAN:ON'); };
    document.getElementById('fanOff').onclick = ()=>{ state.fan=false; document.getElementById('fanState').textContent='OFF'; sendCommand('FAN:OFF'); };
    document.getElementById('heaterOn').onclick = ()=>{ state.heater=true; document.getElementById('heaterState').textContent='ON'; sendCommand('HEATER:ON'); };
    document.getElementById('heaterOff').onclick = ()=>{ state.heater=false; document.getElementById('heaterState').textContent='OFF'; sendCommand('HEATER:OFF'); };

    document.getElementById('modeSelect').onchange = (e)=>{ state.mode = e.target.value; document.getElementById('currentMode').textContent = state.mode==='auto'? 'Automático':'Manual'; };
    document.getElementById('btnReqSample').onclick = ()=>{ sendCommand('REQ_SAMPLE'); };

    /* -------------------- Auto mode rules -------------------- */
    function applyAutoRules(){
      if(state.mode !== 'auto') return;
      const avg = computeAvg(); if(isNaN(avg)) return;
      if(avg > 25){ if(!state.fan){ state.fan=true; sendCommand('FAN:ON'); } state.heater=false; sendCommand('HEATER:OFF'); }
      else if(avg < 20){ if(!state.heater){ state.heater=true; sendCommand('HEATER:ON'); } state.fan=false; sendCommand('FAN:OFF'); }
      else { // between
        if(state.fan){ state.fan=false; sendCommand('FAN:OFF'); }
        if(state.heater){ state.heater=false; sendCommand('HEATER:OFF'); }
      }
      // reflect states on UI
      document.getElementById('fanState').textContent = state.fan? 'ON':'OFF';
      document.getElementById('heaterState').textContent = state.heater? 'ON':'OFF';
    }

    /* -------------------- Bluetooth (Web Bluetooth) -------------------- */
    async function connectBluetooth(){
      // NOTE: Web Bluetooth works only with BLE devices. ESP32 must expose a BLE service and characteristic.
      try{
        const options = {
          // try to use Nordic UART Service (common pattern). If your firmware uses something else, replace the uuid.
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'],
          acceptAllDevices: true
        };
        const device = await navigator.bluetooth.requestDevice(options);
        document.getElementById('btStatus').textContent = 'Bluetooth: conectando...';
        const server = await device.gatt.connect();
        // NUS RX/TX
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        const tx = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e'); // write
        const rx = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e'); // notify
        window.bleWriter = tx;
        await rx.startNotifications();
        rx.addEventListener('characteristicvaluechanged', handleNotifications);
        document.getElementById('btStatus').textContent = 'Bluetooth: conectado — ' + (device.name||device.id);
        state.connected=true;
        device.addEventListener('gattserverdisconnected', ()=>{ state.connected=false; document.getElementById('btStatus').textContent='Bluetooth: desconectado'; });
      }catch(err){ console.error(err); document.getElementById('btStatus').textContent = 'Bluetooth: error ('+err.message+')'; }
    }

    function handleNotifications(evt){
      const decoder = new TextDecoder(); const raw = decoder.decode(evt.target.value); // may contain newlines
      // try parse JSON from raw
      try{
        // sometimes device sends multiple lines; process last valid json-like chunk
        const parts = raw.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length>0);
        for(const p of parts){
          // accept either plain CSV or JSON
          if(p.startsWith('{')){
            const obj = JSON.parse(p);
            const arr = [obj.t1,obj.t2,obj.t3,obj.t4].map(x=>typeof x==='number'?x:parseFloat(x));
            pushSample(arr);
          } else if(p.includes(',')){
            // csv: 23.4,22.9,23.1,22.8
            const nums = p.split(',').map(s=>parseFloat(s)); if(nums.length>=4){ pushSample(nums.slice(0,4)); }
          }
        }
      }catch(e){ console.warn('no se pudo parsear notificación',raw,e); }
    }

    document.getElementById('btnConnect').addEventListener('click', ()=>{ if(navigator.bluetooth) connectBluetooth(); else alert('Web Bluetooth API no está disponible en este navegador.'); });

    /* -------------------- Demo / Mock data (if no BLE) -------------------- */
    // If user never connects, simulate readings so the UI can be previewed.
    let demo = true;
    setInterval(()=>{
      if(state.connected){ demo=false; return; }
      // generate smooth sample
      const base = 22 + Math.sin(Date.now()/60000*2*Math.PI)*3 + (Math.random()-0.5)*0.6;
      const s = [base+ (Math.random()-0.5)*1.0, base+0.3+(Math.random()-0.5)*0.8, base-(Math.random()-0.5)*0.6, base+ (Math.random()-0.5)*0.9];
      pushSample(s.map(x=>parseFloat(x.toFixed(2))));
    }, 3000);

    // initial drawing
    updateGraphs();

    // Expose for debug
    window._state = state;
  </script>
<footer style="text-align:center;margin-top:20px;font-size:18px;font-weight:bold;">Institución: TUVN | Integrantes: José Romero, Abraham Parreño</footer>
</body>
</html>
